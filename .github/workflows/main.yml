name: FB Multi Streamer
on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: 'Source URL'
        required: true
      fb_rtmp:
        description: 'RTMPS'
        required: true
      live_text:
        description: 'Overlay Text'
        required: false
        default: ' '

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: Start Streaming
        run: |
          # تحويل الرابط تلقائياً من rtmps لـ rtmp وحذف البورت 443 لتفادي TLS Fatal Alert
          CLEAN_RTMP=$(echo "${{ github.event.inputs.fb_rtmp }}" | sed 's/rtmps/rtmp/g' | sed 's/:443//g')
          
          echo "Connecting to: $CLEAN_RTMP"

          ffmpeg -re -i "${{ github.event.inputs.m3u8_url }}" \
          -vf "drawtext=text='${{ github.event.inputs.live_text }}':x=(w-tw)/2:y=h-50:fontsize=36:fontcolor=white:box=1:boxcolor=black@0.6" \
          -c:v libx264 -preset superfast -b:v 2000k -maxrate 2000k -bufsize 4000k \
          -pix_fmt yuv420p -g 50 -flags +global_header -c:a aac -b:a 128k -ar 44100 \
          -f flv "$CLEAN_RTMP"
